#!/bin/bash

#
# Install:
#
#   long:  curl -so /tmp/appflow-docker https://raw.githubusercontent.com/ttssdev/appflow/88-appflow-exec-container/containers/bin/appflow-docker ; bash /tmp/appflow-docker
#   short: curl -Lso /tmp/appflow-docker https://goo.gl/4Wq4mk ; bash /tmp/appflow-docker
#
# Troubleshooting:
#
#   Q: Hangs on: injecting ssh key...
#   A: Probably you have a passphrase on ~/.ssh/id_rsa, just do:
#      docker run -u 1000 --rm -v ssh:/ssh -v $HOME:$HOME -it whilp/ssh-agent:latest ssh-add $HOME/.ssh/id_rsa
#      and insert passphrase when asked.
#

CFG_DOCKER_VOLUMES="--volumes-from=ssh-agent -v $HOME/.appflow:/home/appflow/.appflow -v $HOME/.ssh:/home/appflow/.ssh"
CFG_DOCKER_ENVS="-e SSH_AUTH_SOCK=/ssh/auth/sock -e ANSIBLE_HOST_KEY_CHECKING=False -e ANSIBLE_REMOTE_USER=$USER"

function check_dirs() {
  local rc=-1

  if [ -d "$HOME/.appflow" ]; then
    if [ -d "$HOME/.ssh" ]; then
      rc=0
    fi
  fi

  return $rc
}

function check_docker() {
  local rc=-1

  RES=$(docker --version | grep "Docker version")
  if [[ $? -eq 0 ]]; then
    RES=$(docker ps)
    if [[ $? -eq 0 ]]; then
      rc=0
    fi
  fi

  return $rc
}

function check_ssh_agent_container() {
  local rc=-1

  RES=$(docker ps -q -f status=exited -f name=^/ssh-agent$)
  if [ "${RES}" ]; then
    echo -n "starting whilp/ssh-agent... "
    $(docker start ssh-agent > /dev/null)
    if [[ $? -eq 0 ]]; then
      echo "done."
      rc=0
    else
      echo "failed."
    fi
  else
    RES=$(docker ps -q -f status=running -f name=^/ssh-agent$)
    if [ ! "${RES}" ]; then
      echo -n "running whilp/ssh-agent... "
      $(docker run -u 1000 -d -v ssh:/ssh --name=ssh-agent whilp/ssh-agent:latest > /dev/null)
      if [[ $? -eq 0 ]]; then
        echo "done."
        rc=0
      else
        echo "failed."
      fi
    else
      rc=0
    fi
  fi

  return $rc
}

function check_ssh_key() {
  local rc=-1

  $(docker run -u 1000 --rm -v ssh:/ssh -v $HOME:$HOME -it whilp/ssh-agent:latest ssh-add -L >/dev/null)
  if [[ $? -ne 0 ]]; then
    echo -n "injecting ssh key... "
    $(docker run -u 1000 --rm -v ssh:/ssh -v $HOME:$HOME -it whilp/ssh-agent:latest ssh-add $HOME/.ssh/id_rsa >/dev/null)
    if [[ $? -eq 0 ]]; then
      echo "done."
      rc=0
    else
      echo "failed."
    fi

  else
    rc=0
  fi

  return $rc
}


function check_dotfiles() {
  local RES=""

  if [ -d "$HOME/.dotfiles" ]; then
    RES="$HOME/.dotfiles"
  fi

  if [ -d "$HOME/dotfiles" ]; then
    RES="$HOME/dotfiles"
  fi

  echo $RES
}

check_dirs
if [[ $? -eq 0 ]]; then

  check_docker
  if [[ $? -eq 0 ]]; then

    check_ssh_agent_container
    if [[ $? -eq 0 ]]; then

      check_ssh_key
      if [[ $? -eq 0 ]]; then

        RES=$(check_dotfiles)
        if [ "${RES}" ]; then
          CFG_DOCKER_VOLUMES="$CFG_DOCKER_VOLUMES -v $RES:/home/appflow/dotfiles"
        fi

        docker run --name appflow --rm -it $CFG_DOCKER_VOLUMES $CFG_DOCKER_ENVS ttssdev/appflow $@

      fi
    fi

  else
    echo "Docker not available or not running."
    exit -1
  fi

else
  echo "Folder ~/.appflow or ~/.ssh missing."
  exit -1
fi

exit 0
