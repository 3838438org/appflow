#!/usr/bin/env php
<?php

require __DIR__.'/../vendor/autoload.php';

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Config\FileLocator;
use Symfony\Component\Config\Definition\Processor;
use AppFlow\Config\YamlConfigLoader;
use AppFlow\Config\Configuration;

$application = new Application('AppFlow', '1.0.0');

/*
 * https://github.com/bamarni/symfony-console-autocomplete
 *
 * Arguments:
 *  - 1 argument is required, can be:
 *    - about
 *    - help
 *    - list
 *    - checkout
 *    - checkin
 *    - decrypt
 *    - encrpyt
 *    - reset
 *    - support
 *    - update2
 *
 * Options:
 *  - Should be global.
 *    - tenant
 *    - environment
 */

 $application->getDefinition()->addOptions([
     // new InputOption('--env', '-e', InputOption::VALUE_OPTIONAL, 'The environment to operate in.', 'DEV'),
     new InputOption('foo', 'f', InputOption::VALUE_OPTIONAL, 'The environment to operate in.', 'DEV'),
 ]);

$application->addCommands(array(
    new AppFlow\Command\AboutCommand(),
    new AppFlow\Command\CheckoutCommand(),
    new AppFlow\Command\CheckinCommand()
));

// http://symfony.com/doc/current/components/config/resources.html
// $configDirectories = array(__DIR__.'/app/config');
$configDirectories = array($_SERVER['HOME'] . '/.appflow');

// convert the config file into an array
$locator = new FileLocator($configDirectories);
$loader = new YamlConfigLoader($locator);
$configValues = $loader->load($locator->locate('config.yml'));

// process the array using the defined configuration
$processor = new Processor();
$configuration = new Configuration();

try {
    $processedConfiguration = $processor->processConfiguration(
        $configuration,
        $configValues
    );

    // configuration validated
    dump($processedConfiguration);

} catch (Exception $e) {
    echo $e->getMessage() . PHP_EOL;
}

$application->run();
